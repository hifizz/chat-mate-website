# Implementation Plan

- [x] 1. 项目初始化和基础配置
  - [x] 基于 ai-starter-nextjs-shadcnui 脚手架创建项目
  - [x] 安装 Mermaid.js 和 Pako.js 依赖
  - [x] 配置 TypeScript 类型定义
  - **验收标准**:
    - 项目能够成功启动 `pnpm dev`
    - 所有依赖正确安装且无版本冲突
    - TypeScript 编译无错误
    - 基础页面能够正常访问
    - package.json 包含所需的 mermaid 和 pako 依赖
  - _Requirements: 1.1, 1.2_

- [x] 2. URL 参数解析和 Pako 解码功能
  - [x] 实现 URL 参数解析工具函数
  - [x] 实现 Pako 压缩和解压缩功能
  - [x] 添加内容大小验证和 URL 长度检查
  - [x] 编写单元测试验证解码功能
  - **验收标准**:
    - 能够正确解析 URL 中的 pako 参数
    - 压缩和解压缩功能正常工作
    - URL 长度检查能够正确识别超长内容
    - 单元测试覆盖率达到 90% 以上
    - 错误处理能够捕获无效编码
    - 测试用例包含各种边界情况
  - _Requirements: 1.1, 1.2, 1.5_

- [x] 3. Mermaid 图表渲染核心功能
  - [x] 创建 Mermaid 渲染 Hook
  - [x] 实现图表容器组件
  - [x] 处理渲染错误和加载状态
  - [x] 支持动态内容更新
  - **验收标准**:
    - 能够成功渲染基本的 Mermaid 图表（流程图、序列图等）
    - 渲染错误时显示友好的错误信息
    - 加载状态正确显示和隐藏
    - 内容更新时图表能够重新渲染
    - Hook 返回正确的状态和方法
    - 组件能够处理空内容和无效内容
  - _Requirements: 1.3_

- [x] 4. 缩放交互功能实现
  - [x] 实现缩放控制 Hook
  - [x] 添加鼠标滚轮缩放支持
  - [x] 添加触控板双指缩放支持
  - [x] 实现缩放边界限制和平滑动画
  - **验收标准**:
    - 鼠标滚轮能够正常缩放图表
    - 触控板双指手势能够正常缩放
    - 缩放操作保持图表中心点位置
    - 缩放动画流畅自然
    - 达到最大/最小缩放比例时正确限制
    - 缩放比例显示准确
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 5. 主题管理系统
  - [x] 集成 next-themes 深色模式支持
  - [x] 实现 Mermaid 主题切换功能
  - [x] 创建主题选择器 UI 组件
  - [x] 实现主题偏好设置的本地存储
  - **验收标准**:
    - 深色/浅色模式能够正常切换
    - Mermaid 图表主题能够实时更新
    - 主题选择器显示所有可用主题
    - 用户偏好设置能够持久化保存
    - 页面刷新后主题设置保持不变
    - 系统主题偏好能够自动检测
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 6. 图片导出功能
  - [x] 实现 SVG 格式导出
  - [x] 实现 PNG 格式导出（使用 html2canvas）
  - [x] 实现 JPG 格式导出
  - [x] 创建导出选项 UI 组件
  - **验收标准**:
    - SVG 导出生成正确的矢量文件
    - PNG 导出生成高质量的位图文件
    - JPG 导出生成压缩的图片文件
    - 导出的文件能够正常下载
    - 导出选项 UI 界面友好易用
    - 导出过程显示进度提示
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 7. 源码复制功能
  - [x] 实现剪贴板 API 集成
  - [x] 添加复制成功/失败提示
  - [x] 处理浏览器兼容性问题
  - [x] 提供降级的手动复制方案
  - **验收标准**:
    - 点击复制按钮能够将源码复制到剪贴板
    - 复制成功时显示确认提示
    - 复制失败时显示错误信息
    - 不支持剪贴板 API 的浏览器提供文本选择框
    - 复制的内容与原始 Mermaid 代码一致
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 8. AI 语法修复服务
  - [x] 创建 Next.js API Routes 处理 AI 请求
  - [x] 集成 Deepseek API 调用
  - [x] 集成豆包 API 调用
  - [x] 实现 AI 修复结果的应用和预览
  - **验收标准**:
    - API Routes 能够正确处理 AI 请求
    - Deepseek API 集成正常工作
    - 豆包 API 集成正常工作
    - AI 修复建议能够正确应用到图表
    - 服务不可用时显示友好提示
    - 语法正确的代码提示无需修复
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 9. 分享功能实现
  - [x] 实现分享链接生成
  - [x] 添加链接复制到剪贴板功能
  - [x] 处理 URL 长度限制和优化建议
  - [x] 创建分享成功提示 UI
  - **验收标准**:
    - 分享链接能够正确生成
    - 生成的链接能够复制到剪贴板
    - 其他用户访问分享链接能够看到相同内容
    - URL 过长时显示优化建议
    - 分享成功时显示确认信息
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 10. 用户界面组件开发
  - [x] 使用 Shadcn/ui 创建工具栏组件
  - [x] 实现响应式布局设计
  - [x] 添加加载状态和错误提示组件
  - [x] 优化移动端触控体验
  - **验收标准**:
    - 工具栏在桌面端和移动端都能正常显示
    - 响应式布局在不同屏幕尺寸下正常工作
    - 加载状态和错误提示界面友好
    - 移动端触控操作流畅自然
    - 所有 UI 组件符合 Shadcn/ui 设计规范
  - _Requirements: 1.4, 2.1, 2.2_

- [ ] 11. 错误处理和用户体验优化
  - [ ] 实现统一的错误处理机制
  - [ ] 添加友好的错误提示界面
  - [ ] 实现降级处理策略
  - [ ] 添加默认示例图表展示
  - **验收标准**:
    - 所有错误都有统一的处理和显示
    - 错误提示信息清晰易懂
    - 功能不可用时有合适的降级方案
    - 无内容时显示默认示例图表
    - 错误恢复机制正常工作
  - _Requirements: 1.5, 6.4_

- [ ] 12. 性能优化和测试
  - [ ] 添加图表渲染缓存机制
  - [ ] 实现缩放操作防抖处理
  - [ ] 编写端到端测试用例
  - [ ] 进行跨浏览器兼容性测试
  - **验收标准**:
    - 相同内容的图表渲染有缓存优化
    - 频繁缩放操作不会影响性能
    - 端到端测试覆盖主要用户流程
    - 在 Chrome、Firefox、Safari 中正常工作
    - 页面加载时间在可接受范围内
  - _Requirements: 2.4, 2.5_

- [ ] 13. iframe 嵌入支持和最终集成
  - [ ] 测试 iframe 嵌入功能
  - [ ] 优化 iframe 内的用户体验
  - [ ] 进行完整功能集成测试
  - [ ] 部署和生产环境配置
  - **验收标准**:
    - 页面能够在 iframe 中正常显示
    - iframe 内所有功能都能正常工作
    - 完整的用户流程测试通过
    - 生产环境部署成功
    - 所有功能需求都已实现并验证
  - _Requirements: 1.4_

- [x] 14. Playground 页面实现
  - [x] 创建 Playground 页面布局
  - [x] 实现代码编辑器组件（支持语法高亮）
  - [x] 添加实时预览功能
  - [x] 实现参数控制面板
  - [ ] 跳转页面到首页展示刚编辑的Mermaid图
  - [x] 集成 AI 修复功能到编辑器
  - **验收标准**:
    - Playground 页面布局正确，分为左右两栏
    - 代码编辑器支持语法高亮和行号显示
    - 编辑代码时实时更新预览区域
    - 参数控制面板包含所有必要的控制选项
    - AI 修复功能能够分析当前代码并提供修复建议
    - 编辑区的代码存在语法错误时，预览区显示错误信息
    - 用户能够调整设置并实时应用到预览图表
    - 完成编辑后能够保存、导出和分享
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7_